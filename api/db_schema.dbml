Table User {
  id integer [pk, increment]
  email varchar [not null, unique]
  password varchar [not null]
  name varchar [not null]
  surname varchar [not null]
  gender Gender [not null]
  birthdate datetime [not null]
  telephone varchar [not null]  
  profile_picture url
  location varchar

  is_online boolean [not null, default: false]

  email_verified boolean [not null, default: false]
  email_verified_at timestamp

  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    email [unique]
    deleted_at
    telephone
  }
}

Table Coach {
  user_id integer [pk, ref: - User.id]

  status CoachStatus [not null, default: 'PENDING']

  siret varchar [not null]
  iban varchar [not null]
  
  pro_card varchar [not null]
  pro_card_url url [not null]
  expires_at timestamp [not null]
  
  price_per_hour decimal(10,2) [not null]
  workout_duration integer [not null, note: 'Duration in minutes']
  cancellation_hours integer [not null, default: 24, note: 'Hours before workout']

  catch_phrase varchar [not null]
  description varchar [not null]
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
}

Table CoachDiploma {
  coach_id integer [pk, ref: > Coach.user_id, not null]
  diploma Diploma [pk, not null]
  
  diploma_url url [not null]
  
  is_main bool [not null, default: false] // only one
  obtained_at date
  
  indexes {
    (coach_id, diploma) [unique]
  }
}

Table CoachGallery {
  id integer [pk, increment, not null]
  coach_id integer [ref: > Coach.user_id, not null]
  
  display_order integer [not null]
  content_type ContentType [not null]
  content_url url [not null]
  uploaded_at timestamp [not null, default: `now()`]
}

Table CoachDisciplines {
  coach_id integer [pk, ref: > Coach.user_id, not null]
  disciplines Discipline [pk, not null]
}

Table CoachLanguages {
  coach_id integer [pk, ref: > Coach.user_id, not null]
  language Language [pk, not null]
}

Table Workout {
  id integer [pk, increment, not null]
  
  coach_id integer [ref: > Coach.user_id, not null]
  type WorkoutType [not null]

  max_participants integer [note: 'NULL for unlimited, required for GROUP']
  current_participants integer [not null, default: 0]

  scheduled_at timestamp [not null]
  duration integer [not null, note: 'Duration in minutes']
  title varchar [not null]
  location varchar [not null]

  created_at timestamp [not null, default: `now()`]
  updated_at timestamp
  deleted_at timestamp
  
  indexes {
    (coach_id, scheduled_at)
    deleted_at
  }
}

Table Message {
  id integer [pk, increment, not null]

  conversation_id integer [ref: > Conversation.id, not null]
  sender_id integer [ref: > User.id, not null]

  content text [not null]
  
  created_at timestamp [not null, default: `now()`]
  read_at timestamp
  
  indexes {
    (sender_id, created_at)
    (conversation_id, sender_id)
    (conversation_id, created_at)
  }
}

Table Conversation {
  id integer [pk, increment, not null]

  topic varchar // null for SINGLE conversations

  type ConversationType [not null]
  picture url

  created_by integer [ref: > User.id, not null]
  created_at timestamp [not null, default: `now()`]
}

Table ConversationUser {
  conversation_id integer [pk, ref: > Conversation.id, not null]
  user_id integer [pk, ref: > User.id, not null]
  admin bool [not null, default: false]

  indexes {
    user_id
  }
}

Table Review {
  id integer [pk, increment, not null]
  
  workout_id integer [ref: > Workout.id, not null] // only clients who attended the workout can review
  
  client_id integer [ref: > User.id, not null]
  anonymous bool [not null, default: false]

  stars decimal(2,1) [not null, note: 'Between 0.0 and 5.0']
  comment text

  created_at timestamp [not null, default: `now()`]
  edited_at timestamp
  deleted_at timestamp

  indexes {
    (workout_id, client_id) [unique]
    client_id
  }
}

Table ClientToWorkout {
  client_id integer [pk, ref: > User.id, not null]
  workout_id integer [pk, ref: > Workout.id, not null]
  status WorkoutStatus [not null, default: 'PENDING']
  
  indexes {
    client_id
    workout_id
  }
}

Table CoachAvailability {
  id integer [pk, increment]
  coach_id integer [ref: > Coach.user_id, not null]
  
  day_of_week integer [not null, note: '0=Monday, 6=Sunday']
  start_time time [not null]
  end_time time [not null]
  
  is_active boolean [not null, default: true]
  
  indexes {
    (coach_id, day_of_week, is_active)
  }
}

Table CoachStats {
  coach_id integer [pk, ref: - Coach.user_id, not null]
  
  total_reviews integer [not null, default: 0]
  average_stars decimal(3,2) [not null, default: 0]
  total_workouts integer [not null, default: 0]
  total_clients integer [not null, default: 0]
  
  updated_at timestamp [not null, default: `now()`]
}

Table Payment {
  id integer [pk, increment]
  
  workout_id integer [ref: > Workout.id, not null]
  client_id integer [ref: > User.id, not null]
  coach_id integer [ref: > Coach.user_id, not null]
  
  amount decimal(10,2) [not null]
  platform_fee decimal(10,2) [not null]
  coach_payout decimal(10,2) [not null]
  
  status PaymentStatus [not null, default: 'PENDING']
  
  stripe_payment_intent_id varchar [unique]
  stripe_transfer_id varchar
  
  created_at timestamp [not null, default: `now()`]
  paid_at timestamp
  refunded_at timestamp
  
  indexes {
    stripe_payment_intent_id [unique]
    (client_id, created_at)
    (coach_id, created_at)
    status
  }
}

Enum Discipline {
  TENNIS
  BASKETBALL
  FOOTBALL
  RUNNING
}

Enum Language {
  FRENCH
  ENGLISH
  SPANISH
  ARABIC
  CHINESE
  "..."
}

Enum Gender {
  MALE
  FEMALE
  OTHER
}

Enum ContentType {
  PHOTO
  VIDEO
}

Enum WorkoutStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  NO_SHOW
  CANCELLED
}

Enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  DISPUTED
}

Enum Diploma {
  BPJEPS_TENNIS
  DPJEPS_FOOTBALL
  "..."
}

Enum WorkoutType {
  SINGLE
  GROUP
}

Enum ConversationType {
  SINGLE
  GROUP
}

Enum CoachStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}